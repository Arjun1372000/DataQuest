<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AyurTrace Pro</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');

        :root {
            --primary-color: #4CAF50;
            --secondary-color: #66BB6A;
            --accent-color: #FFC107;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 2rem 0;
            text-align: center;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
            box-shadow: var(--shadow);
        }

        header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 600;
        }

        nav {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            margin-top: -20px;
            box-shadow: var(--shadow);
            padding: 10px;
        }

        nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        nav a {
            text-decoration: none;
            color: #555;
            font-weight: 600;
            padding: 8px 15px;
            border-radius: var(--border-radius);
            transition: all 0.3s ease;
        }

        nav a:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        @media (min-width: 768px) {
            .main-content {
                grid-template-columns: 2fr 1fr;
            }
        }

        .card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .card h2 {
            margin-top: 0;
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 10px;
            color: var(--primary-color);
        }

        .stat-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(45deg, #e9f5e9, #d0f0d0);
            padding: 20px;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card .value {
            font-size: 2.5rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .stat-card .label {
            font-size: 1rem;
            color: #666;
        }

        .form-section {
            display: none;
        }

        .form-section.active {
            display: block;
        }

        form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            margin-bottom: 5px;
        }

        input, select, textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-family: inherit;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: var(--secondary-color);
        }

        #trace-result {
            margin-top: 20px;
            background-color: #e8f5e9;
            padding: 15px;
            border-radius: var(--border-radius);
            border-left: 5px solid var(--primary-color);
        }

        #trace-result h3 {
            margin-top: 0;
            color: var(--primary-color);
        }

        .trace-timeline {
            border-left: 3px solid var(--primary-color);
            padding-left: 20px;
            position: relative;
        }

        .timeline-item {
            position: relative;
            padding: 15px 0 15px 30px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background-color: var(--primary-color);
            left: -9px;
            top: 18px;
            border: 2px solid white;
        }

        .timeline-item-title {
            font-weight: 600;
            color: var(--primary-color);
        }

        .timeline-item-details {
            font-size: 0.9em;
            color: #666;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: var(--primary-color);
            color: white;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>AyurTrace Pro</h1>
            <p>Ensuring Authenticity in Ayurvedic Supply Chains</p>
        </div>
    </header>

    <div class="container">
        <nav>
            <ul>
                <li><a href="#" class="nav-link active" data-target="dashboard">Dashboard</a></li>
                <li><a href="#" class="nav-link" data-target="farmer-reg">Farmer Reg.</a></li>
                <li><a href="#" class="nav-link" data-target="batch-reg">Batch Reg.</a></li>
                <li><a href="#" class="nav-link" data-target="processing-reg">Processing</a></li>
                <li><a href="#" class="nav-link" data-target="packaging-reg">Packaging</a></li>
                <li><a href="#" class="nav-link" data-target="transport-reg">Transport</a></li>
                <li><a href="#" class="nav-link" data-target="shop-reg">Shop Reg.</a></li>
                <li><a href="#" class="nav-link" data-target="product-reg">Product Reg.</a></li>
                <li><a href="#" class="nav-link" data-target="trace-product">Trace Product</a></li>
            </ul>
        </nav>

        <div class="main-content">
            <div id="dashboard" class="form-section active">
                <div class="card">
                    <h2>System Overview</h2>
                    <div class="stat-cards">
                        <div class="stat-card">
                            <div class="value" id="total-farmers">0</div>
                            <div class="label">Farmers Registered</div>
                        </div>
                        <div class="stat-card">
                            <div class="value" id="total-batches">0</div>
                            <div class="label">Batches Created</div>
                        </div>
                        <div class="stat-card">
                            <div class="value" id="total-products">0</div>
                            <div class="label">Products Listed</div>
                        </div>
                        <div class="stat-card">
                            <div class="value" id="total-shops">0</div>
                            <div class="label">Shops Registered</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="farmer-reg" class="form-section">
                <div class="card">
                    <h2>Register New Farmer</h2>
                    <form id="farmer-form">
                        <div class="form-group">
                            <label for="farmer-name">Name</label>
                            <input type="text" id="farmer-name" name="name" required>
                        </div>
                        <div class="form-group">
                            <label for="farmer-location">Location</label>
                            <input type="text" id="farmer-location" name="location" required>
                        </div>
                        <div class="form-group">
                            <label for="farmer-contact">Contact Info</label>
                            <input type="text" id="farmer-contact" name="contact">
                        </div>
                        <button type="submit">Add Farmer</button>
                    </form>
                </div>
            </div>

            <div id="batch-reg" class="form-section">
                <div class="card">
                    <h2>Register New Batch</h2>
                    <form id="batch-form">
                        <div class="form-group">
                            <label for="batch-farmer">Farmer</label>
                            <select id="batch-farmer" name="farmer_id" required></select>
                        </div>
                        <div class="form-group">
                            <label for="batch-date">Harvest Date</label>
                            <input type="date" id="batch-date" name="harvest_date" required>
                        </div>
                        <div class="form-group">
                            <label for="batch-herb">Herb Type</label>
                            <input type="text" id="batch-herb" name="herb_type" required>
                        </div>
                        <div class="form-group">
                            <label for="batch-grade">Quality Grade</label>
                            <input type="text" id="batch-grade" name="quality_grade">
                        </div>
                        <button type="submit">Add Batch</button>
                    </form>
                </div>
            </div>

            <div id="processing-reg" class="form-section">
                <div class="card">
                    <h2>Add Processing Step</h2>
                    <form id="processing-form">
                        <div class="form-group">
                            <label for="processing-batch">Batch ID</label>
                            <select id="processing-batch" name="batch_id" required></select>
                        </div>
                        <div class="form-group">
                            <label for="processing-factory">Factory Name</label>
                            <input type="text" id="processing-factory" name="factory_name" required>
                        </div>
                        <div class="form-group">
                            <label for="processing-date">Processing Date</label>
                            <input type="datetime-local" id="processing-date" name="processing_date" required>
                        </div>
                        <div class="form-group">
                            <label for="processing-desc">Step Description</label>
                            <textarea id="processing-desc" name="step_description"></textarea>
                        </div>
                        <button type="submit">Add Processing Step</button>
                    </form>
                </div>
            </div>

            <div id="packaging-reg" class="form-section">
                <div class="card">
                    <h2>Add Packaging Details</h2>
                    <form id="packaging-form">
                        <div class="form-group">
                            <label for="packaging-processing">Processing ID</label>
                            <select id="packaging-processing" name="processing_id" required></select>
                        </div>
                        <div class="form-group">
                            <label for="packaging-date">Packaging Date</label>
                            <input type="datetime-local" id="packaging-date" name="packaging_date" required>
                        </div>
                        <div class="form-group">
                            <label for="packaging-type">Package Type</label>
                            <input type="text" id="packaging-type" name="package_type" required>
                        </div>
                        <div class="form-group">
                            <label for="packaging-units">Units Created</label>
                            <input type="number" id="packaging-units" name="units_created" required>
                        </div>
                        <button type="submit">Add Packaging Details</button>
                    </form>
                </div>
            </div>

            <div id="transport-reg" class="form-section">
                <div class="card">
                    <h2>Add Transport Details</h2>
                    <form id="transport-form">
                        <div class="form-group">
                            <label for="transport-packaging">Packaging ID</label>
                            <select id="transport-packaging" name="packaging_id" required></select>
                        </div>
                        <div class="form-group">
                            <label for="transport-company">Transport Company</label>
                            <input type="text" id="transport-company" name="transport_company" required>
                        </div>
                        <div class="form-group">
                            <label for="transport-date">Shipment Date</label>
                            <input type="datetime-local" id="transport-date" name="shipment_date" required>
                        </div>
                        <div class="form-group">
                            <label for="transport-status">Status</label>
                            <select id="transport-status" name="status" required>
                                <option value="shipped">Shipped</option>
                                <option value="in_transit">In Transit</option>
                                <option value="delivered">Delivered</option>
                            </select>
                        </div>
                        <button type="submit">Add Transport Details</button>
                    </form>
                </div>
            </div>

            <div id="shop-reg" class="form-section">
                <div class="card">
                    <h2>Register New Shop</h2>
                    <form id="shop-form">
                        <div class="form-group">
                            <label for="shop-name">Shop Name</label>
                            <input type="text" id="shop-name" name="name" required>
                        </div>
                        <div class="form-group">
                            <label for="shop-location">Location</label>
                            <input type="text" id="shop-location" name="location" required>
                        </div>
                        <div class="form-group">
                            <label for="shop-contact">Contact Info</label>
                            <input type="text" id="shop-contact" name="contact">
                        </div>
                        <button type="submit">Add Shop</button>
                    </form>
                </div>
            </div>

            <div id="product-reg" class="form-section">
                <div class="card">
                    <h2>Create Final Product</h2>
                    <form id="product-form">
                        <div class="form-group">
                            <label for="product-sku">SKU (Unique ID)</label>
                            <input type="text" id="product-sku" name="sku" required>
                        </div>
                        <div class="form-group">
                            <label for="product-batch">Batch ID</label>
                            <select id="product-batch" name="batch_id" required></select>
                        </div>
                        <div class="form-group">
                            <label for="product-shop">Shop</label>
                            <select id="product-shop" name="shop_id" required></select>
                        </div>
                        <div class="form-group">
                            <label for="product-name">Product Name</label>
                            <input type="text" id="product-name" name="product_name" required>
                        </div>
                        <div class="form-group">
                            <label for="product-creation-date">Creation Date</label>
                            <input type="datetime-local" id="product-creation-date" name="creation_date" required>
                        </div>
                        <button type="submit">Create Product</button>
                    </form>
                </div>
            </div>

            <div id="trace-product" class="form-section">
                <div class="card">
                    <h2>Trace Product Journey</h2>
                    <form id="trace-form">
                        <div class="form-group">
                            <label for="trace-id">Enter SKU or Batch ID</label>
                            <input type="text" id="trace-id" name="id" required>
                        </div>
                        <button type="submit">Trace</button>
                    </form>
                    <div id="trace-result"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            // Function to handle form submissions
            function handleFormSubmission(formId, apiAction) {
                $(formId).on('submit', function(e) {
                    e.preventDefault();
                    var formData = $(this).serialize();
                    $.ajax({
                        url: 'api.php?action=' + apiAction,
                        type: 'POST',
                        data: formData,
                        success: function(response) {
                            if (response.status === 'success') {
                                alert(response.message);
                                $(formId)[0].reset();
                                loadStats(); // Reload stats and other data
                            } else {
                                alert(response.message);
                            }
                        },
                        error: function() {
                            alert('An error occurred. Please try again.');
                        }
                    });
                });
            }

            // Bind forms to API actions
            handleFormSubmission('#farmer-form', 'add_farmer');
            handleFormSubmission('#batch-form', 'add_batch');
            handleFormSubmission('#processing-form', 'add_processing');
            handleFormSubmission('#packaging-form', 'add_packaging');
            handleFormSubmission('#transport-form', 'add_transport');
            handleFormSubmission('#shop-form', 'add_shop');
            handleFormSubmission('#product-form', 'add_product');

            // Load dashboard stats
            function loadStats() {
                $.get('api.php?action=get_stats', function(response) {
                    if (response.status === 'success') {
                        $('#total-farmers').text(response.data.total_farmers);
                        $('#total-batches').text(response.data.total_batches);
                        $('#total-products').text(response.data.total_products);
                        $('#total-shops').text(response.data.total_shops);
                    }
                });
            }
            loadStats();

            // Load farmers for dropdown
            function loadFarmers() {
                $.get('api.php?action=get_farmers', function(response) {
                    var select = $('#batch-farmer');
                    select.empty().append('<option value="">-- Select Farmer --</option>');
                    if (response.status === 'success') {
                        response.data.forEach(function(farmer) {
                            select.append(`<option value="${farmer.farmer_id}">${farmer.name} - ${farmer.location}</option>`);
                        });
                    }
                });
            }

            // Load batches for dropdown
            function loadBatches() {
                $.get('api.php?action=get_batches', function(response) {
                    var select = $('#product-batch');
                    select.empty().append('<option value="">-- Select Batch --</option>');
                    if (response.status === 'success') {
                        response.data.forEach(function(batch) {
                            select.append(`<option value="${batch.batch_id}">Batch ID: ${batch.batch_id} - ${batch.herb_type} (${batch.farmer_name})</option>`);
                        });
                    }
                });
            }
            
            // Load shops for dropdown
            function loadShops() {
                $.get('api.php?action=get_shops', function(response) {
                    var select = $('#product-shop');
                    select.empty().append('<option value="">-- Select Shop --</option>');
                    if (response.status === 'success') {
                        response.data.forEach(function(shop) {
                            select.append(`<option value="${shop.shop_id}">${shop.name} - ${shop.location}</option>`);
                        });
                    }
                });
            }

            // Load processing for dropdown
            function loadProcessing() {
                $.get('api.php?action=get_processing', function(response) {
                    // This would need a new API endpoint to get all processing records
                });
            }

            // Navigation handler
            $('.nav-link').on('click', function(e) {
                e.preventDefault();
                $('.nav-link').removeClass('active');
                $(this).addClass('active');

                $('.form-section').removeClass('active');
                var target = $(this).data('target');
                $('#' + target).addClass('active');

                // Load data for specific forms when their tab is clicked
                if (target === 'batch-reg') {
                    loadFarmers();
                } else if (target === 'product-reg') {
                    loadBatches();
                    loadShops();
                }
            });

            // Trace product handler
            $('#trace-form').on('submit', function(e) {
                e.preventDefault();
                var id = $('#trace-id').val();
                $.get('api.php?action=trace_product&id=' + id, function(response) {
                    var resultDiv = $('#trace-result');
                    resultDiv.empty();
                    if (response.status === 'success') {
                        var traceData = response.data;
                        var timelineHtml = '<h3>Product Journey Trace</h3>';
                        timelineHtml += '<div class="trace-timeline">';

                        if (traceData.farmer) {
                            timelineHtml += `<div class="timeline-item">
                                <div class="timeline-item-title">Farm Origin</div>
                                <div class="timeline-item-details">
                                    <strong>Farmer:</strong> ${traceData.farmer.name}<br>
                                    <strong>Location:</strong> ${traceData.farmer.location}<br>
                                    <strong>Contact:</strong> ${traceData.farmer.contact_info || 'N/A'}
                                </div>
                            </div>`;
                        }

                        if (traceData.batch) {
                            timelineHtml += `<div class="timeline-item">
                                <div class="timeline-item-title">Batch Creation</div>
                                <div class="timeline-item-details">
                                    <strong>Batch ID:</strong> ${traceData.batch.batch_id}<br>
                                    <strong>Herb Type:</strong> ${traceData.batch.herb_type}<br>
                                    <strong>Harvest Date:</strong> ${traceData.batch.harvest_date}<br>
                                    <strong>Quality Grade:</strong> ${traceData.batch.quality_grade || 'N/A'}
                                </div>
                            </div>`;
                        }
                        
                        if (traceData.processing_steps && traceData.processing_steps.length > 0) {
                            traceData.processing_steps.forEach(function(step) {
                                timelineHtml += `<div class="timeline-item">
                                    <div class="timeline-item-title">Processing Step</div>
                                    <div class="timeline-item-details">
                                        <strong>Factory:</strong> ${step.factory_name}<br>
                                        <strong>Date:</strong> ${step.processing_date}<br>
                                        <strong>Description:</strong> ${step.step_description || 'N/A'}
                                    </div>
                                </div>`;
                            });
                        }
                        
                        if (traceData.packaging) {
                            timelineHtml += `<div class="timeline-item">
                                <div class="timeline-item-title">Packaging</div>
                                <div class="timeline-item-details">
                                    <strong>Date:</strong> ${traceData.packaging.packaging_date}<br>
                                    <strong>Package Type:</strong> ${traceData.packaging.package_type}<br>
                                    <strong>Units:</strong> ${traceData.packaging.units_created}
                                </div>
                            </div>`;
                        }
                        
                        if (traceData.transport) {
                            timelineHtml += `<div class="timeline-item">
                                <div class="timeline-item-title">Transport</div>
                                <div class="timeline-item-details">
                                    <strong>Company:</strong> ${traceData.transport.transport_company}<br>
                                    <strong>Shipment Date:</strong> ${traceData.transport.shipment_date}<br>
                                    <strong>Status:</strong> ${traceData.transport.status}
                                </div>
                            </div>`;
                        }
                        
                        if (traceData.shop) {
                            timelineHtml += `<div class="timeline-item">
                                <div class="timeline-item-title">Retail Shop</div>
                                <div class="timeline-item-details">
                                    <strong>Shop Name:</strong> ${traceData.shop.name}<br>
                                    <strong>Location:</strong> ${traceData.shop.location}
                                </div>
                            </div>`;
                        }
                        
                        if (traceData.product) {
                            timelineHtml += `<div class="timeline-item">
                                <div class="timeline-item-title">Final Product</div>
                                <div class="timeline-item-details">
                                    <strong>Product Name:</strong> ${traceData.product.product_name}<br>
                                    <strong>SKU:</strong> ${traceData.product.sku}<br>
                                    <strong>Creation Date:</strong> ${traceData.product.creation_date}
                                </div>
                            </div>`;
                        }

                        timelineHtml += '</div>';
                        resultDiv.html(timelineHtml);
                    } else {
                        resultDiv.html(`<div style="color: red;">${response.message}</div>`);
                    }
                });
            });

        });
    </script>
</body>
</html>